 
getgenv().Replion = nil
getgenv().Promise = nil
getgenv().ItemUtility = nil
getgenv().ItemStringUtility = nil
getgenv().PromptController = nil

getgenv().moduleAccept = pcall(function()
    getgenv().Replion = require(replicatedStorage:WaitForChild("Packages"):WaitForChild("Replion"))
    getgenv().Promise = require(replicatedStorage:WaitForChild("Packages"):WaitForChild("Promise"))
    getgenv().ItemUtility = require(replicatedStorage:WaitForChild("Shared"):WaitForChild("ItemUtility"))
    getgenv().ItemStringUtility = require(replicatedStorage:WaitForChild("Modules"):WaitForChild("ItemStringUtility"))
    getgenv().PromptController = require(replicatedStorage:WaitForChild("Controllers"):WaitForChild("PromptController"))
end)

getgenv().oldItemTradingController = nil
getgenv().Tabs.PlayerSetTab:CreateToggle({
    Name = "Auto Accept Prompt Trade",
    CurrentValue = false,
    Flag = "AutoAcceptTrade",
    Callback = function(value)
        if value then
            -- Aktifkan auto accept (tanpa prompt)
            if   getgenv().PromptController and getgenv().Promise then
                if not getgenv().oldItemTradingController then
                    getgenv().oldItemTradingController = hookfunction(getgenv().PromptController.FirePrompt, function(self, promptText, ...)
                       if type(promptText) == "string" and (
            promptText:find("Accept")
            or promptText:find("from:")
            or promptText:find("to give")
        ) then
                            return getgenv().Promise.resolve(true)
                        end
                        return getgenv().oldItemTradingController(self, promptText, ...)
                    end)
                end
            end

           
        else
            -- Kembalikan fungsi ke normal (dengan prompt)
            if getgenv().oldItemTradingController then
                hookfunction(getgenv().PromptController.FirePrompt, getgenv().oldItemTradingController)
                getgenv().oldItemTradingController = nil
            end
           
        end
    end
})

local PromptController = require(game:GetService("ReplicatedStorage").Controllers.PromptController)

-- Simpan hook lama
getgenv().oldDrawPrompt = getgenv().oldDrawPrompt or PromptController.DrawPrompt

-- Tambahkan toggle di Rayfield
getgenv().Tabs.PlayerSetTab:CreateToggle({
    Name = "Auto Accept Prompt Trade V2",
    CurrentValue = false,
    Flag = "AutoAcceptPromptTradeV2",
    Callback = function(value)
        if value then
            -- Aktifkan auto accept
            PromptController.DrawPrompt = function(self, promptEntry)
                local text = tostring(promptEntry.TextPrompt or "")
                print("[AutoPrompt] Prompt muncul:", text)

                if text:find("Accept") or text:find("from:") or text:find("to give") then
                    print("[AutoPrompt] ✅ Auto-accept YES")
                    local internal = rawget(PromptController, "_internal")
                    if internal and internal.bindable then
                        -- langsung fire tanpa delay
                        internal.bindable:Fire(true)
                    end
                else
                    print("[AutoPrompt] ❌ Tidak cocok, biarkan manual")
                end

                return getgenv().oldDrawPrompt(self, promptEntry)
            end

        else
            -- Matikan auto accept, kembalikan fungsi asli
            PromptController.DrawPrompt = getgenv().oldDrawPrompt
            print("[AutoPrompt] Auto-accept dimatikan, fungsi kembali normal.")
        end
    end
})

-- Hook metamethod global
getgenv().oldAFKScript = hookmetamethod(game, "__namecall", newcclosure(function(self, ...)
    local method = getnamecallmethod()

    if method == "FireServer" and tostring(self) == "ReconnectPlayer" then 
        return nil  
    end

    return getgenv().oldAFKScript(self, ...)
end))